# V3.3 ADDENDUM - Mean Reversion & Weekly Income Priority

**Version:** 3.4  
**Status:** ✅ IMPLEMENTED  
**Created:** January 7, 2026  
**Updated:** January 8, 2026  
**Builds On:** V3.0 Specification  
**Philosophy:** Weekly income generation with mean reversion awareness

---

## Executive Summary

V3.3/3.4 adds critical refinements based on real-world usage and user feedback:

1. **Weekly Income Priority** - Compression over extension for profitable positions
2. **Mean Reversion Awareness** - Different handling for near-term vs far-term ITM
3. **ITM Escape with Flexible Debit** - Absolute debit limits based on urgency
4. **WAIT Recommendations** - TA-driven hold signals for uncovered positions
5. **Data Source Architecture** - Schwab primary, Yahoo for earnings only
6. **TA-based MONITOR for ITM** (V3.4) - Check support/resistance before escaping ITM

---

## Core Principle Update

### V3.0 Said:
> "Find zero-cost roll to ANY expiration needed (1 week to 12 months)"

### V3.3 Clarifies:
> **"Weekly income generation takes priority over escaping ITM."**
>
> For slightly ITM, profitable positions: **COMPRESS time first, extend only if necessary.**
> The goal is to stay on the weekly income cycle, not to escape ITM at all costs.

---

## New Decision Framework

### V3.3 Position Evaluation Flow

```
┌─────────────────────────────────────────────────────────────────┐
│              POSITION EVALUATION FRAMEWORK v3.3                  │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  IF ITM:                                                         │
│    ├─ Near expiry (≤60 days) → ESCAPE: Roll to OTM urgently     │
│    │   • Use absolute debit limits ($2-$5 based on severity)    │
│    │   • Find SHORTEST time to get OTM                          │
│    │                                                             │
│    └─ Far expiry (>60 days) → Try COMPRESS, else MONITOR        │
│        ├─ COMPRESS (same strike): Shorten at same strike        │
│        │   Accept ≤$1 debit (cost-neutral)                      │
│        │                                                         │
│        ├─ COMPRESS (OTM escape): Shorten AND get OTM            │
│        │   Accept ≤$5 debit                                      │
│        │                                                         │
│        └─ MONITOR: No compress found, wait for mean reversion   │
│            • Stock spiked up → will likely pull back             │
│            • Check again next scan for compress opportunity      │
│                                                                  │
│  IF SLIGHTLY ITM (<5%) + PROFITABLE (>60%):                     │
│    └─ PREFER COMPRESS over EXTEND (preserve weekly income)      │
│        • Roll to SHORTER duration even if staying ITM           │
│        • Accept higher strike to earn credit                     │
│                                                                  │
│  IF SLIGHTLY ITM (≤8%) + TIME (≥5 days):                        │
│    └─ CHECK TA before escaping (V3.4)                           │
│        • PUT ITM + at support → MONITOR (wait for bounce)       │
│        • CALL ITM + at resistance → MONITOR (wait for pullback) │
│        • Otherwise → proceed to ESCAPE                          │
│                                                                  │
│  IF OTM:                                                         │
│    ├─ Far expiry (>8 weeks) → PULL-BACK: Return to shorter      │
│    ├─ Near expiry + ≥60% profit → ROLL: Capture profits         │
│    └─ Near expiry + <60% profit → HOLD: Wait for time decay     │
│                                                                  │
│  UNCOVERED POSITIONS:                                            │
│    └─ Use Technical Analysis (RSI, Bollinger) for SELL vs WAIT  │
│        • RSI < 30 (oversold) → WAIT for bounce                  │
│        • RSI > 70 (overbought) → SELL NOW                       │
│        • RSI neutral + middle of bands → SELL NOW               │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## Change 1: Weekly Income Priority

**Status:** ✅ IMPLEMENTED via PULL_BACK + Weekly Income Compress fallback

### Problem (V3.0)
Position: AVGO $350 Put Jan 23, Stock $346 (1.1% ITM), 79% profit captured

V3.0 recommended: Roll to $345 Put **Jan 30** (extend OUT by 7 days)

**Issue:** This sacrifices a week of income to escape ITM.

### Solution (V3.3)
For slightly ITM + profitable positions, **compress first**:

✅ **RIGHT:** Roll to $340 Put Jan 16 with **$5.65 CREDIT** (compress IN, preserves weekly cycle)
❌ **WRONG:** Roll to $345 Put Jan 30 (extend OUT, lose weekly cycle)

### Implementation
The fix uses a **two-layer approach**:

1. **PULL_BACK (State 1)** - Already handles compression for profitable positions
   - Runs FIRST in evaluation, BEFORE ITM checks
   - Found: AVGO → Jan 16 $340 with $5.65 credit
   
2. **Weekly Income Compress (State 1.5)** - Fallback for edge cases
   - Triggers when: slightly ITM (<5%) AND profitable (>60%)
   - Runs BEFORE the normal ITM escape logic
   - Ensures compress is always considered before extend

### Logic
```python
# STATE 1: Pull-back runs first (highest priority)
if pull_back_opportunity_exists():
    return PULL_BACK  # Already compresses for profitable positions

# STATE 1.5: Weekly income compress (added in V3.3)
if is_slightly_itm(< 5%) and is_profitable(>= 60%):
    compress = find_weekly_income_compress(max_debit=$1.00)
    if compress:
        return COMPRESS  # Preserve weekly income
    # Fall through to normal ITM handling

# STATE 2: ITM escape (only if no compress found)
if is_itm:
    return ESCAPE_ITM
```

### Rationale
1. Extending to Jan 30 = lose 1 week of income ($50-100/contract)
2. Compressing to Jan 16 = stay on weekly cycle, earn credit
3. For small ITM amounts (1-2%), compression risk is acceptable
4. Weekly income compounds over 52 weeks - don't waste weeks

---

## Change 2: Mean Reversion Awareness

### Problem (V3.0)
Position: TSLA $370 Call Sep 18 (8 months out), Stock $435 (17% ITM)

V3.0 would: Search for escape roll, likely find one 24+ weeks out

**Issue:** The position is already 8 months out. Mean reversion will likely help.

### Solution (V3.3)
Different handling based on time to expiration:

| Days to Expiry | ITM Handling | Rationale |
|----------------|--------------|-----------|
| ≤ 60 days | **ESCAPE NOW** | Assignment risk is real |
| > 60 days | **COMPRESS or MONITOR** | Mean reversion will help |

### COMPRESS Logic (Far-Dated ITM)
```python
if is_itm and days_to_exp > 60:
    # Target window: 45-90 days (optimal for mean reversion)
    
    # Approach 1: Same-strike compress (cost-neutral)
    if can_roll_to_shorter_same_strike(max_debit=$1):
        return COMPRESS_SAME_STRIKE
    
    # Approach 2: OTM escape compress
    if can_roll_to_shorter_and_otm(max_debit=$5):
        return COMPRESS_OTM_ESCAPE
    
    # No compress available - wait for opportunity
    return MONITOR
```

### Example
TSLA $370 Sep (17% ITM, 254 days out):
1. Check: Can we roll Sep $370 → Mar $370 at ≤$1 debit? **No** ($35 debit)
2. Check: Can we roll Sep $370 → Mar $440 at ≤$5 debit? **No** ($40+ debit)
3. Result: **MONITOR** - wait for stock to pull back or volatility change

---

## Change 3: ITM Escape with Flexible Debit

### Problem (V3.0)
Position: MU $295 Call Jan 16 (15% ITM, 9 days out)

V3.0 rule: max_debit = 20% of original_premium = $0.40

**Issue:** Original premium was $2.00, so max debit is only $0.40. But there's a roll to $340 March at $4.20 that would save the position.

### Solution (V3.3)
Use **absolute debit limits** based on ITM severity, not percentage:

| ITM Severity | Max Debit | Priority |
|--------------|-----------|----------|
| Slightly ITM (1-5%) | $2.00 | Medium |
| Moderately ITM (5-10%) | $3.00 | High |
| Deeply ITM (>10%) | $5.00 | Urgent |

### Logic
```python
def get_max_debit_for_itm_escape(itm_pct, original_premium):
    # Use the HIGHER of: percentage rule OR absolute limit
    percentage_limit = original_premium * 0.20
    
    if itm_pct >= 10:
        absolute_limit = 5.0  # Urgent - pay up to $5 to escape
    elif itm_pct >= 5:
        absolute_limit = 3.0  # High priority
    else:
        absolute_limit = 2.0  # Medium priority
    
    return max(percentage_limit, absolute_limit)
```

### Example
MU $295 (15% ITM), original premium $2.00:
- V3.0: max_debit = $2.00 × 0.20 = **$0.40** → Cannot find roll
- V3.3: max_debit = max($0.40, $5.00) = **$5.00** → Found $340 March at $4.20 ✅

---

## Change 4: WAIT Recommendations (Technical Analysis)

### Problem
User has uncovered shares. Should they sell calls immediately or wait?

### Solution (V3.3)
Use Technical Analysis to determine SELL vs WAIT:

| RSI | Bollinger Position | Recommendation | Rationale |
|-----|-------------------|----------------|-----------|
| < 30 | Near lower band | **WAIT** | Oversold, likely bounce |
| > 70 | Near upper band | **SELL NOW** | Overbought, good premium |
| 30-70 | Middle of bands | **SELL NOW** | Neutral, start earning |

### Example
NFLX (5 uncovered contracts), RSI = 26.7:
```
⏸️ WAIT: NFLX (5 uncovered) · Stock $91
RSI at 26.7 (oversold) - stock likely to bounce, wait to sell
```

### Logic
```python
def should_wait_to_sell(symbol):
    ta = get_technical_analysis(symbol)
    
    if ta.rsi < 30:
        return WAIT, f"RSI at {ta.rsi:.1f} (oversold) - likely bounce"
    
    if ta.rsi > 70:
        return SELL_NOW, f"RSI at {ta.rsi:.1f} (overbought) - good premium"
    
    if ta.price < ta.bollinger_lower * 1.02:
        return WAIT, f"At lower Bollinger band - likely bounce"
    
    return SELL_NOW, "Neutral - start earning"
```

---

## Change 5: TA-based MONITOR for ITM Positions (V3.4)

**Status:** ✅ IMPLEMENTED (Jan 8, 2026)  
**File:** `backend/app/modules/strategies/position_evaluator.py`

### Problem (V3.3)
Position: AVGO $355 PUT Jan 16, Stock $333 (6.5% ITM), 8 days to expiry

V3.3 recommended: **Roll to $330 March 20** (10 weeks out, $2.10 credit)

**Issues:**
1. Stock is at **29% of Bollinger Band** (near lower support)
2. Still have **8 days** before expiration
3. Rolling to March **loses 10 weeks of income potential**
4. Mean reversion suggests stock will bounce from support

### Solution (V3.4)
Before escaping ITM, check Technical Analysis:

| Option Type | MONITOR When | Because |
|-------------|--------------|---------|
| **PUT ITM** | Stock at SUPPORT (BB < 35% or RSI < 40) | Stock will bounce UP → less ITM |
| **CALL ITM** | Stock at RESISTANCE (BB > 65% or RSI > 60) | Stock will pull back → less ITM |

### Logic
```python
# STATE 1.6: TA-based MONITOR for slightly ITM (V3.4)
TA_MONITOR_MAX_ITM_PCT = 8.0  # Apply to ≤8% ITM
TA_MONITOR_MIN_DAYS = 5       # Need at least 5 days

if is_itm and itm_pct <= 8.0 and days_to_exp >= 5:
    ta = get_technical_indicators(symbol)
    bb_position = (price - bb_lower) / (bb_upper - bb_lower) * 100
    
    if option_type == 'put':
        # PUT ITM: Monitor if stock at support
        if bb_position < 35 or rsi < 40:
            return MONITOR("Stock at support, wait for bounce")
    
    else:  # call
        # CALL ITM: Monitor if stock at resistance
        if bb_position > 65 or rsi > 60:
            return MONITOR("Stock at resistance, wait for pullback")
    
    # Only escape if TA doesn't support mean reversion
```

### Example
**AVGO $355 PUT Jan 16** (6.5% ITM, 8 days left):

| Indicator | Value | Interpretation |
|-----------|-------|----------------|
| BB Position | 29% | Near LOWER band (support) |
| RSI | 56 | Neutral |
| Nearest Support | $330.71 | Stock at $332 - very close |

**V3.3:** Roll to March 20 at $330 (lose 10 weeks income)  
**V3.4:** MONITOR - wait for bounce from support ✅

### When to Escape vs Monitor

| Scenario | Action |
|----------|--------|
| PUT ITM + Stock at SUPPORT | **MONITOR** - wait for bounce |
| PUT ITM + Stock NOT at support | **ESCAPE** - roll to OTM |
| CALL ITM + Stock at RESISTANCE | **MONITOR** - wait for pullback |
| CALL ITM + Stock NOT at resistance | **ESCAPE** - roll to OTM |
| Any ITM + < 5 days to expiry | **ESCAPE** - no time for mean reversion |
| ITM > 8% | **ESCAPE** - too deep, don't wait |

---

## Change 6: Data Source Architecture

### V3.3 Data Sources

| Data Type | Primary Source | Fallback | Notes |
|-----------|---------------|----------|-------|
| Stock Prices | **Schwab API** | None | Real-time |
| Option Chains | **Schwab API** | None | Real-time, includes Greeks |
| Price History | **Schwab API** | Yahoo | For TA calculations |
| Available Expirations | **Schwab API** | Yahoo | Use actual dates, not calculated |
| Earnings Dates | **Yahoo Finance** | None | Schwab doesn't provide this |

### Key Change
**Use actual available expirations from Schwab**, not calculated weeks.

```python
# V3.0 (WRONG) - calculated dates might not exist
for weeks in [1, 2, 3, 4, 6, 8, 12]:
    expiration = today + timedelta(weeks=weeks)
    # This date might not have options!

# V3.3 (CORRECT) - use actual available dates
available_expirations = schwab.get_option_expirations(symbol)
for exp_date in available_expirations:
    # This date definitely has options
```

---

## Change 6: Notification Enhancements

### Dual Notification Modes
| Mode | Description | Use Case |
|------|-------------|----------|
| **Verbose** | All snapshots from each scan | Full transparency |
| **Smart** | Only new or changed recommendations | Noise reduction |

### Notification Title Format
```
ROLL: AVGO $350.00→$345.00 01/30 · $0.80 credit
ROLL: MU $295.00→$340.00 03/20 · $6.50 debit
WAIT: NFLX (5 uncovered) · Stock $91
SELL: AAPL (17 uncovered) · Earn $340
```

### Account Ordering (NEO)
1. Neel's Brokerage
2. Neel's Retirement
3. Neel's Roth IRA
4. Jaya's Brokerage
5. Jaya's IRA
6. Jaya's Roth IRA
7. Other

---

## Configuration Updates

### V3.3 Configuration Additions

```python
V3_3_CONFIG = {
    # === MEAN REVERSION ===
    "itm_compress_threshold_days": 60,  # ITM + >60 days = try compress
    "compress_target_min_days": 45,     # Target window: 45-90 days
    "compress_target_max_days": 90,
    
    # === FLEXIBLE DEBIT LIMITS ===
    "itm_escape_debit_limits": {
        "slight_itm_max": 2.0,    # 1-5% ITM
        "moderate_itm_max": 3.0,  # 5-10% ITM
        "deep_itm_max": 5.0,      # >10% ITM
    },
    "same_strike_compress_max_debit": 1.0,  # For cost-neutral compress
    
    # === WEEKLY INCOME PRIORITY ===
    "prefer_compress_when": {
        "max_itm_pct": 5.0,       # Only for slightly ITM
        "min_profit_pct": 60.0,   # Only if profitable
    },
    
    # === TECHNICAL ANALYSIS ===
    "ta_wait_signals": {
        "rsi_oversold": 30,       # Wait if RSI < 30
        "rsi_overbought": 70,     # Sell if RSI > 70
        "bollinger_buffer": 0.02, # 2% buffer from bands
    },
}
```

---

## Examples

### Example 1: Weekly Income Priority

**Position:** AVGO $350 Put Jan 23, Stock $346 (1.1% ITM), 79% profit

| Approach | Action | Result |
|----------|--------|--------|
| V3.0 | Roll to $345 Jan 30 | ❌ Loses weekly cycle |
| **V3.3** | Roll to $340 Jan 16 | ✅ Preserves weekly cycle, earns $5.65 credit |

**V3.3 Logic (Actual Result):**
1. STATE 1 (PULL_BACK): Runs first
2. Found: Jan 16 $340 with $5.65 CREDIT
3. **Recommend: PULL_BACK to Jan 16**

Note: The PULL_BACK detector catches this because it already prioritizes compression for profitable positions. The "Weekly Income Compress" fallback (State 1.5) exists for edge cases where pull-back doesn't find an opportunity.

---

### Example 2: Mean Reversion (Far-Dated ITM)

**Position:** TSLA $370 Call Sep 18, Stock $435 (17% ITM), 254 days out

| Approach | Action | Result |
|----------|--------|--------|
| V3.0 | Search for escape, find 24+ weeks | ❌ Unnecessary extension |
| **V3.3** | Try compress, else MONITOR | ✅ Wait for mean reversion |

**V3.3 Logic:**
1. ITM (17%) + Far expiry (254 days > 60) → Try COMPRESS
2. Same-strike compress (Sep $370 → Mar $370): $35 debit ❌
3. OTM escape compress (Sep $370 → Mar $440): $40+ debit ❌
4. **Recommend: MONITOR** - wait for pullback opportunity

---

### Example 3: ITM Escape with Flexible Debit

**Position:** MU $295 Call Jan 16, Stock $340 (15% ITM), 9 days out

| Approach | Max Debit | Result |
|----------|-----------|--------|
| V3.0 | $0.40 (20% of $2) | ❌ "Cannot escape within 12 months" |
| **V3.3** | $5.00 (absolute limit) | ✅ Roll to $340 March at $4.20 |

**V3.3 Logic:**
1. Near expiry (9 days < 60) → ESCAPE needed
2. 15% ITM → Deep ITM → max_debit = $5.00
3. Found: $340 March at $4.20 debit ✓
4. **Recommend: ROLL_ITM to $340 March**

---

### Example 4: WAIT Recommendation

**Position:** NFLX, 5 uncovered contracts, RSI = 26.7

| Approach | Action | Result |
|----------|--------|--------|
| V3.0 | SELL immediately | ❌ Sells at bottom |
| **V3.3** | WAIT for bounce | ✅ Better entry point |

**V3.3 Logic:**
1. RSI = 26.7 < 30 → Oversold
2. **Recommend: WAIT** - "RSI at 26.7 (oversold) - stock likely to bounce"

---

## Migration Notes

### From V3.0 to V3.3

| Component | Change Required |
|-----------|-----------------|
| `position_evaluator.py` | Add COMPRESS logic, flexible debit |
| `zero_cost_finder.py` | Use actual expirations from Schwab |
| `new_covered_call.py` | Add TA-based WAIT logic |
| `technical_analysis.py` | Add Schwab price history support |
| `v2_notification_service.py` | Add premium/debit to titles |

### New Actions Added
- `COMPRESS` - Shorten time window for far-dated ITM
- `MONITOR` - Wait for compress opportunity
- `WAIT` (for uncovered) - TA-driven hold signal

---

## Quick Reference

### When to COMPRESS vs EXTEND

| Situation | Action | Why |
|-----------|--------|-----|
| ITM + ≤60 days | EXTEND to escape | Assignment risk |
| ITM + >60 days | COMPRESS or MONITOR | Mean reversion |
| Slightly ITM + profitable | COMPRESS | Weekly income |

### Max Debit Limits (ITM Escape)

| ITM % | Max Debit | Priority |
|-------|-----------|----------|
| 1-5% | $2.00 | Medium |
| 5-10% | $3.00 | High |
| >10% | $5.00 | Urgent |

### TA Signals for Uncovered

| RSI | Band Position | Action |
|-----|---------------|--------|
| <30 | Lower | WAIT |
| >70 | Upper | SELL |
| 30-70 | Middle | SELL |

---

**END OF V3.3 ADDENDUM**

---

**Last Updated:** January 7, 2026  
**Version:** 3.3.0  
**Status:** ✅ IMPLEMENTED

